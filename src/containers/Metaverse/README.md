# Three.js å®ç°3Då¼€æ”¾ä¸–ç•Œå°æ¸¸æˆï¼šé˜¿ç‹¸çš„å¤šå…ƒå®‡å®™ ğŸ¦Š

![banner](./images/banner.gif)

> å£°æ˜ï¼šæœ¬æ–‡æ¶‰åŠå›¾æ–‡å’Œæ¨¡å‹ç´ æä»…ç”¨äºä¸ªäººå­¦ä¹ ã€ç ”ç©¶å’Œæ¬£èµï¼Œè¯·å‹¿äºŒæ¬¡ä¿®æ”¹ã€éæ³•ä¼ æ’­ã€è½¬è½½ã€å‡ºç‰ˆã€å•†ç”¨ã€åŠè¿›è¡Œå…¶ä»–è·åˆ©è¡Œä¸ºã€‚

## èƒŒæ™¯

> **2545å…‰å¹´**ä¹‹å¤–çš„**å¼€æ™®å‹’1028æ˜Ÿç³»**ï¼Œæœ‰ä¸€é¢—è‰²å½©æ–‘æ–“çš„å®œå±…æ˜Ÿçƒ `ğŸŒ‘`ï¼Œæ˜Ÿé™…ç§»æ°‘ `ğŸ‘¨â€ğŸš€` å¿…é¡»ç©¿æˆ´**åŸºåœ°**å‘æ”¾çš„é˜²è¾å°„æœæ‰èƒ½ç”Ÿå­˜ã€‚é˜¿ç‹¸ `ğŸ¦Š` é©¾é©¶æ˜Ÿé™…é£è¡Œå™¨ `ğŸš€` é™ä¸´æ­¤åœ°ï¼Œå¿«å¸®å®ƒåœ¨é™å®šæ—¶é—´å†…ä½¿ç”¨**è½®ç›˜**ç§»åŠ¨**æ‰¾åˆ°åŸºåœ°**è·å–é˜²è¾å°„æœå§ï¼

![logo](./images/logo.png)

æœ¬æ–‡ä½¿ç”¨ `Three.js + React + CANNON` æŠ€æœ¯æ ˆï¼Œå®ç°é€šè¿‡æ»‘åŠ¨å±å¹•æ§åˆ¶æ¨¡å‹åœ¨ `3D` ä¸–ç•Œé‡Œè¿åŠ¨çš„ `Low Poly` ä½å¤šè¾¹å½¢é£æ ¼å°æ¸¸æˆã€‚æœ¬æ–‡ä¸»è¦æ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹åŒ…æ‹¬ï¼š`Three.js` é˜´å½±ç±»å‹ã€åˆ›å»ºç²’å­ç³»ç»Ÿã€`cannon.js` åŸºæœ¬ç”¨æ³•ã€ä½¿ç”¨ `cannon.js` é«˜åº¦åœº `Heightfield` åˆ›å»ºåœ°å½¢ã€é€šè¿‡è½®ç›˜ç§»åŠ¨æ§åˆ¶æ¨¡å‹åŠ¨ç”»ç­‰ã€‚

## æ•ˆæœ

* **æ¸¸æˆç©æ³•**ï¼šç‚¹å‡»å¼€å§‹æ¸¸æˆæŒ‰é’®ï¼Œé€šè¿‡æ“ä½œå±å¹•åº•éƒ¨è½®ç›˜æ¥ç§»åŠ¨é˜¿ç‹¸ï¼Œåœ¨å€’è®¡æ—¶é™å®šæ—¶é—´å†…æ‰¾åˆ°åŸºåœ°ã€‚
* **ä¸»çº¿ä»»åŠ¡**ï¼šé™å®šæ—¶é—´å†…æ‰¾åˆ°åº‡æŠ¤æ‰€ã€‚
* **æ”¯çº¿ä»»åŠ¡**ï¼šè‡ªç”±æ¢ç´¢å¼€æ”¾ä¸–ç•Œã€‚

![mobile](./images/mobile.png)

**åœ¨çº¿é¢„è§ˆ**ï¼š

* `ğŸ‘€` åœ°å€1ï¼š<https://3d-eosin.vercel.app/#/metaverse>
* `ğŸ‘€` åœ°å€2ï¼š<https://dragonir.github.io/3d/#/metaverse>

å·²é€‚é…:

* `ğŸ’»` `PC` ç«¯
* `ğŸ“±` ç§»åŠ¨ç«¯

> `ğŸš©` å°æç¤ºï¼šç«™å¾—è¶Šé«˜çœ‹å¾—è¶Šè¿œï¼Œéšéšçº¦çº¦å¬è¯´åŸºåœ°ä½äºåˆå§‹ä½ç½®çš„**è¥¿é¢**ï¼Œå¼€å§‹æ—¶åº”è¯¥å‘å·¦å‰æ–¹å‰è¿›å“¦ã€‚

## è®¾è®¡

æ¸¸æˆæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šé¡µé¢åŠ è½½å®Œæˆåç©å®¶ `ğŸ‘¨â€ğŸš€` ç‚¹å‡»å¼€å§‹æŒ‰é’®ï¼Œç„¶ååœ¨é™å®šæ—¶é—´å†…é€šè¿‡æ§åˆ¶é¡µé¢åº•éƒ¨è½®ç›˜ `ğŸ•¹` ç§»åŠ¨æ¨¡å‹ï¼Œæ‰¾åˆ°ç›®æ ‡åŸºåœ°æ‰€åœ¨çš„ä½ç½®ã€‚å¯»æ‰¾æˆåŠŸæˆ–å¤±è´¥éƒ½ä¼šæ˜¾ç¤ºç»“æœé¡µ `ğŸ†`ï¼Œç»“æœä¸Šé¢æœ‰ä¸¤ä¸ªæŒ‰é’®**å†è¯•ä¸€æ¬¡**å’Œ**è‡ªç”±æ¢ç´¢**ï¼Œç‚¹å‡»**å†è¯•ä¸€æ¬¡**æ—¶é—´ä¼šé‡ç½®ï¼Œç„¶åé‡æ–°å›åˆ°èµ·ç‚¹å¼€å§‹å€’è®¡æ—¶ã€‚ç‚¹å‡»**è‡ªç”±æ¢ç´¢**åˆ™ä¸åœ¨è®¡æ—¶ï¼Œç©å®¶å¯ä»¥åœ¨ `3D` å¼€æ”¾ä¸–ç•Œé‡Œæ“ä½œæ¨¡å‹è‡ªç”±æ¢ç´¢ã€‚åŒæ—¶ï¼Œæ¸¸æˆå†…é¡µé¢ä¹Ÿæä¾›ä¸€ä¸ª**æ—¶å…‰å€’æµ**æŒ‰é’®ï¼Œå®ƒçš„ä½œç”¨æ˜¯ç©å®¶ `ğŸ‘¨â€ğŸš€` å¯ä»¥åœ¨å¤±è´¥å‰è‡ªå·±æ‰‹åŠ¨é‡ç½®å€’è®¡æ—¶ `â³`ï¼Œé‡æ–°å›åˆ°èµ·ç‚¹å¼€å§‹æ¸¸æˆã€‚

![progress](./images/progress.png)

## å®ç°

### åŠ è½½èµ„æº

åŠ è½½å¼€å‘æ‰€éœ€çš„å¿…å¤‡èµ„æºï¼š`GLTFLoader` ç”¨äºåŠ è½½ç‹ç‹¸ `ğŸ¦Š` å’ŒåŸºåœ° `ğŸ ` æ¨¡å‹ã€`CANNON` æ˜¯ç”¨äºåˆ›å»º `3D` ä¸–ç•Œçš„ç‰©ç†å¼•æ“ï¼›`CannonHelper` æ˜¯å¯¹ `CANNON` ä¸€äº›ä½¿ç”¨æ–¹æ³•çš„å°è£…ï¼›`JoyStick` ç”¨äºåˆ›å»ºé€šè¿‡ç›‘å¬é¼ æ ‡ç§»åŠ¨ä½ç½®æˆ–è§¦ç¢°å±å¹•äº§ç”Ÿçš„ä½ç§»æ¥æ§åˆ¶æ¨¡å‹ç§»åŠ¨çš„è½®ç›˜ `ğŸ•¹`ã€‚

```js
import * as THREE from 'three';
import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader';
import CANNON from 'cannon';
import CannonHelper from './scripts/CannonHelper';
import JoyStick from './scripts/JoyStick';
```

### é¡µé¢ç»“æ„

é¡µé¢ç»“æ„æ¯”è¾ƒç®€å•ï¼Œ`.webgl` ç”¨äºæ¸²æŸ“ `WEBGL`ï¼›`.tool` æ˜¯æ¸¸æˆå†…çš„å·¥å…·æ ï¼Œç”¨äºé‡ç½®æ¸¸æˆå’Œæ˜¾ç¤ºä¸€äº›æç¤ºè¯­ï¼›`.loading` æ˜¯æ¸¸æˆåŠ è½½é¡µé¢ï¼Œç”¨æ¥æ˜¾ç¤ºæ¸¸æˆåŠ è½½è¿›åº¦ã€ä»‹ç»æ¸¸æˆè§„åˆ™ã€æ˜¾ç¤ºæ¸¸æˆå¼€å§‹æŒ‰é’®ï¼›`.result` æ˜¯æ¸¸æˆç»“æœé¡µé¢ï¼Œç”¨äºæ˜¾ç¤ºæ¸¸æˆæˆåŠŸæˆ–å¤±è´¥ç»“æœï¼Œå¹¶æä¾›**å†è¯•ä¸€æ¬¡**å’Œ**è‡ªç”±æ¢ç´¢**ä¸¤ä¸ªæŒ‰é’® `ğŸ”˜`ã€‚

```js
(<div id="metaverse">
  <canvas className='webgl'></canvas>
  <div className='tool'>
    <div className='countdown'>{ this.state.countdown }</div>
    <button className='reset_button' onClick={this.resetGame}>æ—¶å…‰å€’æµ</button>
    <p className='hint'>ç«™å¾—è¶Šé«˜çœ‹å¾—è¶Šè¿œ</p>
  </div>
  { this.state.showLoading ? (<div className='loading'>
    <div className='box'>
      <p className='progress'>{this.state.loadingProcess} %</p>
      <p className='description'>æ¸¸æˆæè¿°</p>
      <button className='start_button' style={{'visibility': this.state.loadingProcess === 100 ? 'visible' : 'hidden'}} onClick={this.startGame}>å¼€å§‹æ¸¸æˆ</button>
    </div>
  </div>) : '' }
  { this.state.showResult ? (<div className='result'>
    <div className='box'>
      <p className='text'>{ this.state.resultText }</p>
      <button className='button' onClick={this.resetGame}>å†è¯•ä¸€æ¬¡</button>
      <button className='button' onClick={this.discover}>è‡ªç”±æ¢ç´¢</button>
    </div>
  </div>) : '' }
</div>)
```

### æ•°æ®åˆå§‹åŒ–

æ•°æ®å˜é‡åŒ…æ‹¬åŠ è½½è¿›åº¦ã€æ˜¯å¦æ˜¾ç¤ºåŠ è½½é¡µé¢ã€æ˜¯å¦æ˜¾ç¤ºç»“æœé¡µã€ç»“æœé¡µæ–‡æ¡ˆã€å€’è®¡æ—¶ã€æ˜¯å¦å¼€å¯è‡ªç”±æ¢ç´¢ç­‰ã€‚

```js
state = {
  loadingProcess: 0,
  showLoading: true,
  showResult: false,
  resultText: 'å¤±è´¥',
  countdown: 60,
  freeDiscover: false
}
```

### åœºæ™¯åˆå§‹åŒ–

åˆå§‹åŒ–åœºæ™¯ `ğŸ”`ã€ç›¸æœº `ğŸ“·`ã€å…‰æº `ğŸ’¡`ã€‚

```js
const renderer = new THREE.WebGLRenderer({
  canvas: document.querySelector('canvas.webgl'),
  antialias: true,
  alpha: true
});
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
const scene = new THREE.Scene();
// æ·»åŠ ä¸»ç›¸æœº
const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, .01, 100000);
camera.position.set(1, 1, -1);
camera.lookAt(scene.position);
// æ·»åŠ ç¯å¢ƒå…‰
const ambientLight = new THREE.AmbientLight(0xffffff, .4);
scene.add(ambientLight)
// æ·»åŠ å¹³è¡Œå…‰
var light = new THREE.DirectionalLight(0xffffff, 1);
light.position.set(1, 1, 1).normalize();
scene.add(light);
```

#### `ğŸ’¡` Three.js é˜´å½±ç±»å‹

æœ¬æ–‡ä½¿ç”¨äº† `THREE.PCFSoftShadowMap` ä»¥å¼€å¯æ•ˆæœæ›´åŠ æŸ”å’Œçš„é˜´å½±ï¼Œ`Three.js` æä¾›ä»¥ä¸‹å‡ ç§é˜´å½±ç±»å‹ï¼š

* `THREE.BasicShadowMap`ï¼šæä¾›æœªç»è¿‡æ»¤çš„é˜´å½±è´´å›¾ï¼Œæ€§èƒ½æœ€å¿«ï¼Œä½†è´¨é‡æœ€ä½ã€‚
* `THREE.PCFShadowMap`ï¼šä½¿ç”¨ `Percentage-Closer Filtering (PCF)` ç®—æ³•è¿‡æ»¤é˜´å½±è´´å›¾ï¼Œæ˜¯é»˜è®¤ç±»å‹ã€‚
* `THREE.PCFSoftShadowMap`ï¼šä½¿ç”¨ `PCF` ç®—æ³•è¿‡æ»¤çš„æ›´åŠ æŸ”å’Œçš„é˜´å½±è´´å›¾ï¼Œå°¤å…¶æ˜¯åœ¨ä½¿ç”¨ä½åˆ†è¾¨ç‡é˜´å½±è´´å›¾æ—¶ã€‚
* `THREE.VSMShadowMap`ï¼šä½¿ç”¨æ–¹å·®é˜´å½±è´´å›¾ `VSM` ç®—æ³•è¿‡æ»¤çš„é˜´å½±è´´å›¾ã€‚ ä½¿ç”¨ `VSMShadowMap` æ—¶ï¼Œæ‰€æœ‰é˜´å½±æ¥æ”¶è€…ä¹Ÿä¼šæŠ•å°„é˜´å½±ã€‚

### åˆ›å»ºä¸–ç•Œ

ä½¿ç”¨ `Cannon.js` åˆå§‹åŒ–ç‰©ç†ä¸–ç•Œ `ğŸŒ`ã€‚

```js
// åˆå§‹åŒ–ç‰©ç†ä¸–ç•Œ
const world = new CANNON.World();
// åœ¨å¤šä¸ªæ­¥éª¤çš„ä»»æ„è½´ä¸Šæµ‹è¯•åˆšä½“çš„ç¢°æ’
world.broadphase = new CANNON.SAPBroadphase(world);
// è®¾ç½®ç‰©ç†ä¸–ç•Œçš„é‡åŠ›ä¸ºæ²¿yè½´å‘ä¸Š-10ç±³æ¯äºŒæ¬¡æ–¹ç§’
world.gravity.set(0, -10, 0);
// åˆ›å»ºé»˜è®¤è”ç³»æè´¨
world.defaultContactMaterial.friction = 0;
const groundMaterial = new CANNON.Material("groundMaterial");
const wheelMaterial = new CANNON.Material("wheelMaterial");
const wheelGroundContactMaterial = new CANNON.ContactMaterial(wheelMaterial, groundMaterial, {
  // æ‘©æ“¦ç³»æ•°
  friction: 0,
  // æ¢å¤ç³»æ•°
  restitution: 0,
  // æ¥è§¦åˆšåº¦
  contactEquationStiffness: 1000
});
world.addContactMaterial(wheelGroundContactMaterial);
```

#### `ğŸ’¡` Cannon.js

`Cannon.js` æ˜¯ç”¨ `JavaScript` å®ç°çš„ç‰©ç†å¼•æ“åº“ï¼Œå¯ä»¥ä¸ä»»ä½•æ”¯æŒæµè§ˆå™¨çš„æ¸²æŸ“æˆ–æ¸¸æˆå¼•æ“ï¼Œå¯ä»¥ç”¨äºæ¨¡æ‹Ÿåˆšä½“ï¼Œå®ç° `3D` ä¸–ç•Œ `ğŸŒ` ä¸­æ›´åŠ çœŸå®çš„ç‰©ç†å½¢å¼çš„ç§»åŠ¨å’Œäº¤äº’ã€‚æ›´å¤š `Cannon.js` ç›¸å…³ `API` æ–‡æ¡£å’Œç¤ºä¾‹å¯ä»¥å‚è€ƒæ–‡ç« æœ«å°¾é“¾æ¥ã€‚

### åˆ›å»ºæ˜Ÿç©º

åˆ›å»º `1000` ä¸ªç²’å­ç”¨äºæ¨¡å‹æ˜Ÿç©º `âœ¨`ï¼Œå¹¶å°†å®ƒä»¬æ·»åŠ åˆ°åœºæ™¯ä¸­ã€‚æœ¬ç¤ºä¾‹ä¸­é€šè¿‡ç€è‰²å™¨å½¢å¼åˆ›å»ºç²’å­ï¼Œè¿™æ ·æ›´æœ‰åˆ©äº `GPU` æ¸²æŸ“æ•ˆç‡ã€‚

```js
const textureLoader = new THREE.TextureLoader();
const shaderPoint = THREE.ShaderLib.points;
const uniforms = THREE.UniformsUtils.clone(shaderPoint.uniforms);
uniforms.map.value = textureLoader.load(snowflakeTexture);
for (let i = 0; i < 1000; i++) {
  sparkGeometry.vertices.push(new THREE.Vector3());
}
const sparks = new THREE.Points(new THREE.Geometry(), new THREE.PointsMaterial({
  size: 2,
  color: new THREE.Color(0xffffff),
  map: uniforms.map.value,
  blending: THREE.AdditiveBlending,
  depthWrite: false,
  transparent: true,
  opacity: 0.75
}));
sparks.scale.set(1, 1, 1);
sparks.geometry.vertices.map(spark => {
  spark.y = randnum(30, 40);
  spark.x = randnum(-500, 500);
  spark.z = randnum(-500, 500);
  return true;
});
scene.add(sparks);
```

![star](./images/star.png)

### åˆ›å»ºåœ°å½¢

é€šè¿‡ `CANNON.Heightfield` é«˜åº¦åœºåˆ›å»º `128 x 128 x 60` å¯è§†åŒ–æ¸å˜è‰²åœ°å½¢ã€‚åœ°å½¢çš„å‡¹å‡¸èµ·ä¼çŠ¶æ€æ˜¯é€šè¿‡ä»¥ä¸‹é«˜åº¦å›¾ `HeightMap` å®ç°ï¼Œå®ƒæ˜¯ä¸€å¼ é»‘ç™½å›¾ç‰‡ `ğŸ–¼`ï¼Œé€šè¿‡åƒç´ ç‚¹çš„é¢œè‰²æ·±æµ…æ¥è®°å½•é«˜åº¦ä¿¡æ¯ï¼Œæ ¹æ®é«˜åº¦å›¾æ•°æ®ä¿¡æ¯åˆ›å»ºåœ°å½¢ç½‘æ ¼ã€‚å¯é€šè¿‡æ–‡ç« æœ«å°¾æä¾›çš„é“¾æ¥åœ¨çº¿ç”Ÿæˆéšæœºé«˜åº¦å›¾ã€‚åœ°å½¢ç”Ÿæˆå®Œæˆå¹¶å°†å®ƒæ·»åŠ åˆ°ä¸–ç•Œ `ğŸŒ` ä¸­ï¼Œç„¶ååœ¨ `animate` æ–¹æ³•ä¸­é¡µé¢é‡ç»˜æ—¶è°ƒç”¨ `check` æ–¹æ³•ï¼Œç”¨äºæ£€æµ‹å’Œæ›´æ–°æ¨¡å‹åœ¨åœ°å½¢ä¸Šçš„ä½ç½®ã€‚

![HeightMap](./images/HeightMap.png)

```js
const cannonHelper = new CannonHelper(scene);
var sizeX = 128, sizeY = 128, minHeight = 0, maxHeight = 60, check = null;
Promise.all([
  // åŠ è½½é«˜åº¦å›¾
  img2matrix.fromUrl(heightMapImage, sizeX, sizeY, minHeight, maxHeight)(),
]).then(function (data) {
  var matrix = data[0];
  // åœ°å½¢ä½“
  const terrainBody = new CANNON.Body({ mass: 0 });
  // åœ°å½¢å½¢çŠ¶
  const terrainShape = new CANNON.Heightfield(matrix, { elementSize: 10 });
  terrainBody.addShape(terrainShape);
  // åœ°å½¢ä½ç½®
  terrainBody.position.set(-sizeX * terrainShape.elementSize / 2, -10, sizeY * terrainShape.elementSize / 2);
  // è®¾ç½®ä»è½´è§’åº¦
  terrainBody.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), -Math.PI / 2);
  world.add(terrainBody);
  // å°†ç”Ÿæˆçš„åœ°å½¢åˆšä½“å¯è§†åŒ–
  cannonHelper.addVisual(terrainBody, 'landscape');
  var raycastHelperGeometry = new THREE.CylinderGeometry(0, 1, 5, 1.5);
  raycastHelperGeometry.translate(0, 0, 0);
  raycastHelperGeometry.rotateX(Math.PI / 2);
  var raycastHelperMesh = new THREE.Mesh(raycastHelperGeometry, new THREE.MeshNormalMaterial());
  scene.add(raycastHelperMesh);
  // ä½¿ç”¨ Raycasteræ£€æµ‹å¹¶æ›´æ–°æ¨¡å‹åœ¨åœ°å½¢ä¸Šçš„ä½ç½®
  check = () => {
    var raycaster = new THREE.Raycaster(target.position, new THREE.Vector3(0, -1, 0));
    var intersects = raycaster.intersectObject(terrainBody.threemesh.children[0]);
    if (intersects.length > 0) {
      raycastHelperMesh.position.set(0, 0, 0);
      raycastHelperMesh.lookAt(intersects[0].face.normal);
      raycastHelperMesh.position.copy(intersects[0].point);
    }
    target.position.y = intersects && intersects[0] ? intersects[0].point.y + 0.1 : 30;
    var raycaster2 = new THREE.Raycaster(shelterLocation.position, new THREE.Vector3(0, -1, 0));
    var intersects2 = raycaster2.intersectObject(terrainBody.threemesh.children[0]);
    shelterLocation.position.y = intersects2 && intersects2[0] ? intersects2[0].point.y + .5 : 30;
    shelterLight.position.y = shelterLocation.position.y + 50;
    shelterLight.position.x = shelterLocation.position.x + 5
    shelterLight.position.z = shelterLocation.position.z;
  }
});
```

![land](./images/land.png)

#### `ğŸ’¡` CANNON.Heightfield

æœ¬ç¤ºä¾‹ä¸­å‡¹å‡¸ä¸å¹³çš„åœ°å½¢æ˜¯é€šè¿‡ `CANNON.Heightfield` å®ç°çš„ï¼Œå®ƒæ˜¯ `Cannon.js` ç‰©ç†å¼•æ“çš„é«˜åº¦åœºã€‚åœ¨ç‰©ç†å­¦ä¸­æŠŠ**æŸä¸ªç‰©ç†é‡åœ¨ç©ºé—´ä¸­ä¸€ä¸ªåŒºåŸŸå†…çš„åˆ†å¸ƒ**ç§°ä¸º**åœº**ï¼Œé«˜åº¦åœºå°±æ˜¯ä¸é«˜åº¦ç›¸å…³çš„åœºã€‚`Heightfield` çš„é«˜åº¦å°±æ˜¯å…³äºä¸¤ä¸ªå˜é‡çš„å‡½æ•°ï¼Œå¯ä»¥è¡¨è¾¾ä¸º `HEIGHT(i,j)`ã€‚

```js
Heightfield(data, options)
```

* `data` æ˜¯ä¸€ä¸ª `yå€¼` æ•°ç»„ï¼Œå°†ç”¨äºæ„å»ºåœ°å½¢ã€‚
* `options` æ˜¯ä¸€ä¸ªé…ç½®é¡¹ï¼Œæœ‰ä¸‰ä¸ªå¯é…ç½®å‚æ•°ï¼š
  * `minValue` æ˜¯æ•°æ®æ•°ç»„ä¸­æ•°æ®ç‚¹çš„æœ€å°å€¼ã€‚å¦‚æœæœªç»™å‡ºï¼Œå°†è‡ªåŠ¨è®¡ç®—ã€‚
  * `maxValue` æœ€å¤§å€¼ã€‚
  * `elementSize` æ˜¯ `xè½´` æ–¹å‘ä¸Šæ•°æ®ç‚¹ä¹‹é—´çš„ä¸–ç•Œé—´è·ã€‚

### åŠ è½½è¿›åº¦ç®¡ç†

ä½¿ç”¨ `LoadingManager` ç®¡ç†åŠ è½½è¿›åº¦ï¼Œå½“é¡µé¢æ¨¡å‹åŠ è½½å®Œæˆä¹‹åï¼ŒåŠ è½½è¿›åº¦é¡µé¢æ˜¾ç¤º**å¼€å§‹æ¸¸æˆèœå•**ã€‚

```js
const loadingManager = new THREE.LoadingManager();
loadingManager.onProgress = async (url, loaded, total) => {
  this.setState({ loadingProcess: Math.floor(loaded / total * 100) });
};
```

![loading](./images/loading.png)

### åˆ›å»ºåŸºåœ°æ¨¡å‹

åŠ è½½åŸºåœ°æ¨¡å‹ `ğŸ ` å‰å…ˆåˆ›å»ºä¸€ä¸ª `shelterLocation` ç½‘æ ¼ç”¨æ¥æ”¾ç½®åŸºåœ°æ¨¡å‹ï¼Œè¯¥ç½‘æ ¼å¯¹è±¡è¿˜ç”¨äºåç»­åœ°å½¢æ£€æµ‹ã€‚ç„¶åä½¿ç”¨ `GLTFLoader` åŠ è½½åŸºåœ°æ¨¡å‹ï¼Œç„¶åæŠŠå®ƒæ·»åŠ åˆ° `shelterLocation` ç½‘æ ¼ä¸Šã€‚æœ€åæ·»åŠ ä¸€ä¸ª `PointLight` `ğŸ’¡` ç»™åŸºåœ°æ¨¡å‹æ·»åŠ å½©è‰²ç‚¹å…‰æºï¼Œæ·»åŠ ä¸€ä¸ª `DirectionalLight` `ğŸ’¡` ç”¨äºç”Ÿæˆé˜´å½±ã€‚

```js
const shelterGeometry = new THREE.BoxBufferGeometry(0.15, 2, 0.15);
const shelterLocation = new THREE.Mesh(shelterGeometry, new THREE.MeshNormalMaterial({
  transparent: true,
  opacity: 0
}));
shelterLocation.position.set(this.shelterPosition.x, this.shelterPosition.y, this.shelterPosition.z);
shelterLocation.rotateY(Math.PI);
scene.add(shelterLocation);
// åŠ è½½æ¨¡å‹
gltfLoader.load(Shelter, mesh => {
  mesh.scene.traverse(child => {
    child.castShadow = true;
  });
  mesh.scene.scale.set(5, 5, 5);
  mesh.scene.position.y = -.5;
  shelterLocation.add(mesh.scene)
});
// æ·»åŠ å…‰æº
const shelterPointLight = new THREE.PointLight(0x1089ff, 2);
shelterPointLight.position.set(0, 0, 0);
shelterLocation.add(shelterPointLight);
const shelterLight = new THREE.DirectionalLight(0xffffff, 0);
shelterLight.position.set(0, 0, 0);
shelterLight.castShadow = true;
shelterLight.target = shelterLocation;
scene.add(shelterLight);
```

![shelter](./images/shelter.png)

### åˆ›å»ºé˜¿ç‹¸æ¨¡å‹

ç‹ç‹¸ `ğŸ¦Š` æ¨¡å‹çš„åŠ è½½ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªç›®æ ‡ç½‘æ ¼ï¼Œåç»­ç”¨äºåœ°å½¢æ£€æµ‹ï¼Œç„¶åæŠŠç‹ç‹¸ `ğŸ¦Š` æ¨¡å‹æ·»åŠ åˆ°ç›®æ ‡ç½‘æ ¼ä¸Šã€‚ç‹ç‹¸ `ğŸ¦Š` æ¨¡å‹å®ŒæˆåŠ è½½åï¼Œéœ€è¦ä¿å­˜å®ƒçš„ `clip1`ã€ `clip1` ä¸¤ç§åŠ¨ç”»æ•ˆæœï¼Œåç»­éœ€è¦é€šè¿‡åˆ¤æ–­è½®ç›˜ `ğŸ•¹` çš„ç§»åŠ¨çŠ¶æ€æ¥åˆ¤æ–­æ’­æ”¾å“ªç§åŠ¨ç”»ã€‚æœ€åæ·»åŠ ä¸€ä¸ª `DirectionalLight` `ğŸ’¡` å…‰æºæ¥äº§ç”Ÿé˜´å½±ã€‚

```js
var geometry = new THREE.BoxBufferGeometry(.5, 1, .5);
geometry.applyMatrix4(new THREE.Matrix4().makeTranslation(0, .5, 0));
const target = new THREE.Mesh(geometry, new THREE.MeshNormalMaterial({
  transparent: true,
  opacity: 0
}));
scene.add(target);

var mixers = [], clip1, clip2;
const gltfLoader = new GLTFLoader(loadingManager);
gltfLoader.load(foxModel, mesh => {
  mesh.scene.traverse(child => {
    if (child.isMesh) {
      child.castShadow = true;
      child.material.side = THREE.DoubleSide;
    }
  });
  var player = mesh.scene;
  player.position.set(this.playPosition.x, this.playPosition.y, this.playPosition.z);
  player.scale.set(.008, .008, .008);
  target.add(player);
  var mixer = new THREE.AnimationMixer(player);
  clip1 = mixer.clipAction(mesh.animations[0]);
  clip2 = mixer.clipAction(mesh.animations[1]);
  clip2.timeScale = 1.6;
  mixers.push(mixer);
});

const directionalLight = new THREE.DirectionalLight(new THREE.Color(0xffffff), .5);
directionalLight.position.set(0, 1, 0);
directionalLight.castShadow = true;
directionalLight.target = target;
target.add(directionalLight);
```

![fox](./images/fox.png)

### æ§åˆ¶é˜¿ç‹¸è¿åŠ¨

ä½¿ç”¨è½®ç›˜æ§åˆ¶å™¨ç§»åŠ¨é˜¿ç‹¸ `ğŸ¦Š` æ¨¡å‹æ—¶ï¼Œå®æ—¶æ›´æ–°æ¨¡å‹çš„æ–¹å‘ï¼Œè‹¥è½®ç›˜äº§ç”Ÿä½ç§»ï¼Œæ›´æ–°æ¨¡å‹ä½ç§»å¹¶æ’­æ”¾å¥”è·‘åŠ¨ç”»ï¼Œå¦åˆ™æ’­æ”¾ç¦æ­¢åŠ¨ç”»ã€‚åŒæ—¶æ ¹æ®æ¨¡å‹ç›®æ ‡çš„ä½ç½®ï¼Œå®æ—¶æ›´æ–°ç›¸æœº `ğŸ“·` çš„ä½ç½®ï¼Œç”Ÿæˆç¬¬ä¸‰äººç§°è§†è§’ã€‚è½®ç›˜ç§»åŠ¨æ§åˆ¶æ¨¡å‹ç§»åŠ¨åŠŸèƒ½æ˜¯é€šè¿‡å¼•å…¥ `JoyStick` ç±»æ¥å®ç°ï¼Œå®ƒçš„ä¸»è¦å®ç°åŸç†æ˜¯ç›‘å¬é¼ æ ‡æˆ–ç‚¹è§¦ä½ç½®ï¼Œç„¶åé€šè¿‡è®¡ç®—æ˜ å°„åˆ°æ¨¡å‹ä½ç½®å˜åŒ–ä¸Šã€‚

```js
var setup = { forward: 0, turn: 0 };
new JoyStick({ onMove: (forward, turn) => {
  setup.forward = forward;
  setup.turn = -turn;
}});
const updateDrive = (forward = setup.forward, turn = setup.turn) => {
  let maxSteerVal = 0.05;
  let maxForce = .15;
  let force = maxForce * forward;
  let steer = maxSteerVal * turn;
  if (forward !== 0) {
    target.translateZ(force);
    clip2 && clip2.play();
    clip1 && clip1.stop();
  } else {
    clip2 && clip2.stop();
    clip1 && clip1.play();
  }
  target.rotateY(steer);
}
// ç”Ÿæˆç¬¬ä¸‰äººç§°è§†è§’
const followCamera = new THREE.Object3D();
followCamera.position.copy(camera.position);
scene.add(followCamera);
followCamera.parent = target;
const updateCamera = () => {
  if (followCamera) {
    camera.position.lerp(followCamera.getWorldPosition(new THREE.Vector3()), 0.1);
    camera.lookAt(target.position.x, target.position.y + .5, target.position.z);
  }
}
```

![preview](./images/preview.png)

> `ğŸš©` è½®ç›˜æ§åˆ¶å™¨ `JoyStick` ç±»å…·ä½“å®ç°å¯å‚è€ƒæ–‡ç« æœ«å°¾ `Codepen` é“¾æ¥ [5]ã€‚

### åŠ¨ç”»æ›´æ–°

åœ¨é¡µé¢é‡ç»˜åŠ¨ç”»ä¸­ï¼Œæ›´æ–°ç›¸æœºã€æ¨¡å‹çŠ¶æ€ã€`Cannon` ä¸–ç•Œã€åœºæ™¯æ¸²æŸ“ç­‰ã€‚

```js
var clock = new THREE.Clock();
var lastTime;
var fixedTimeStep = 1.0 / 60.0;
const animate = () => {
  updateCamera();
  updateDrive();
  let delta = clock.getDelta();
  mixers.map(x => x.update(delta));
  let now = Date.now();
  lastTime === undefined && (lastTime = now);
  let dt = (Date.now() - lastTime) / 1000.0;
  lastTime = now;
  world.step(fixedTimeStep, dt);
  cannonHelper.updateBodies(world);
  check && check();
  renderer.render(scene, camera);
  requestAnimationFrame(animate);
};
```

### é¡µé¢ç¼©æ”¾é€‚é…

é¡µé¢äº§ç”Ÿç¼©æ”¾æ—¶ï¼Œæ›´æ–°æ¸²æŸ“åœºæ™¯ `ğŸ”` å’Œç›¸æœº `ğŸ“·`ã€‚

```js
window.addEventListener('resize', () => {
  var width = window.innerWidth, height = window.innerHeight;
  renderer.setSize(width, height);
  camera.aspect = width / height;
  camera.updateProjectionMatrix();
}, false);
```

åˆ°æ­¤ï¼Œæ¸¸æˆä¸‰ç»´ä¸–ç•Œ `ğŸŒ` å·²ç»å…¨éƒ¨å®ç°å®Œæ¯•äº†ã€‚

![complete](./images/complete.gif)

### æ·»åŠ æ¸¸æˆé€»è¾‘

æ ¹æ®å‰é¢çš„æ¸¸æˆæµç¨‹è®¾è®¡ï¼Œç°åœ¨æ·»åŠ æ¸¸æˆé€»è¾‘ï¼Œå¼€å§‹æ¸¸æˆæ—¶é‡ç½®æ•°æ®å¹¶å¼€å§‹ `60s` å€’è®¡æ—¶ `â³` ï¼›é‡ç½®æ¸¸æˆæ—¶å°†é˜¿ç‹¸ `ğŸ¦Š` ä½ç½®ã€æ–¹å‘åŠç›¸æœºä½ç½®è®¾ç½®ä¸ºåˆå§‹çŠ¶æ€ï¼›è‡ªç”±æ¢ç´¢æ—¶å¼€å¯è‡ªç”±æ¢ç´¢çŠ¶æ€ï¼Œå¹¶æ¸…é™¤å€’è®¡æ—¶ã€‚`â³`

```js
startGame = () => {
  this.setState({
    showLoading : false,
    showResult: false,
    countdown: 60,
    resultText: 'å¤±è´¥',
    freeDiscover: false
  },() => {
    this.interval = setInterval(() => {
      if (this.state.countdown > 0) {
        this.setState({
          countdown: --this.state.countdown
        });
      } else {
        clearInterval(this.interval)
        this.setState({
          showResult: true
        });
      }
    }, 1000);
  });
}
resetGame = () => {
  this.player.position.set(this.playPosition.x, this.playPosition.y, this.playPosition.z);
  this.target.rotation.set(0, 0, 0);
  this.target.position.set(0, 0, 0);
  this.camera.position.set(1, 1, -1);
  this.startGame();
}
discover = () => {
  this.setState({
    freeDiscover: true,
    showResult: false,
    countdown: 60
  }, () => {
    clearInterval(this.interval);
  });
}
```

### æ¯›ç»ç’ƒæ•ˆæœ

`Loading` é¡µé¢ã€ç»“æœé¡µé¢ä»¥åŠå›åˆ°è¿‡å»æŒ‰é’®éƒ½é‡‡ç”¨äº†**æ¯›ç»ç’ƒæ•ˆæœ**æ ·å¼ `ğŸ’§`ï¼Œé€šè¿‡ä»¥ä¸‹å‡ è¡Œæ ·å¼ä»£ç ï¼Œå³å¯å®ç°æƒŠè‰³çš„æ¯›ç»ç’ƒã€‚

```stylus
background rgba(0, 67, 170, .5)
backdrop-filter blur(10px)
filter drop-shadow(0px 1px 1px rgba(0, 0, 0, .25))
```

![result](./images/result.png)

## æ€»ç»“

æœ¬æ–‡æ¶‰åŠåˆ°çš„æ–°çŸ¥è¯†ç‚¹ä¸»è¦åŒ…æ‹¬ï¼š

* `Three.js` é˜´å½±ç±»å‹
* åˆ›å»ºç²’å­ç³»ç»Ÿ
* `cannon.js` åŸºæœ¬ç”¨æ³•
* ä½¿ç”¨ `cannon.js` é«˜åº¦åœº `Heightfield` åˆ›å»ºåœ°å½¢
* é€šè¿‡è½®ç›˜ç§»åŠ¨æ§åˆ¶æ¨¡å‹åŠ¨ç”»

> æƒ³äº†è§£åœºæ™¯åˆå§‹åŒ–ã€å…‰ç…§ã€é˜´å½±ã€åŸºç¡€å‡ ä½•ä½“ã€ç½‘æ ¼ã€æè´¨åŠå…¶ä»–**Three.js**çš„ç›¸å…³çŸ¥è¯†ï¼Œå¯é˜…è¯»æˆ‘å¾€æœŸæ–‡ç« ã€‚**è½¬è½½è¯·æ³¨æ˜åŸæ–‡åœ°å€å’Œä½œè€…**ã€‚å¦‚æœè§‰å¾—æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œä¸è¦å¿˜äº†**ä¸€é”®ä¸‰è¿å“¦ ğŸ‘**ã€‚

## é™„å½•

* [1]. [Three.js ç«ç„°æ•ˆæœå®ç°è‰¾å°”ç™»æ³•ç¯åŠ¨æ€logo](https://juejin.cn/post/7077726955528781832)
* [2]. [Three.js å®ç°ç¥å¥‡çš„3Dæ–‡å­—æ‚¬æµ®æ•ˆæœ](https://juejin.cn/post/7072899771819622413)
* [3]. [Three.js å®ç°è®©äºŒç»´å›¾ç‰‡å…·æœ‰3Dæ•ˆæœ](https://juejin.cn/post/7067344398912061454)
* [4]. [Three.js å®ç°2022å†¬å¥¥ä¸»é¢˜3Dè¶£å‘³é¡µé¢ï¼Œå†°å¢©å¢© ğŸ¼](https://juejin.cn/post/7060292943608807460)
* [5]. [Three.js åˆ¶ä½œä¸€ä¸ªä¸“å±3Då¥–ç‰Œ](https://juejin.cn/post/7055079293247815711)
* [6]. [Three.js å®ç°è™å¹´æ˜¥èŠ‚3Dåˆ›æ„é¡µé¢](https://juejin.cn/post/7051745314914435102)
* [7]. [Three.js å®ç°è„¸ä¹¦å…ƒå®‡å®™3DåŠ¨æ€Logo](https://juejin.cn/post/7031893833163997220)
* [8]. [Three.js å®ç°3Då…¨æ™¯ä¾¦æ¢å°æ¸¸æˆ](https://juejin.cn/post/7042298964468564005)
* [9]. [Three.js å®ç°ç‚«é…·çš„é…¸æ€§é£æ ¼3Dé¡µé¢](https://juejin.cn/post/7012996721693163528)

## å‚è€ƒèµ„æ–™

* [1] [threejs.org](https://threejs.org/)
* [2] [cannonjs.org](http://www.cannonjs.org/)
* [3] [heightmap-generator](http://heightmap-generator.com/)
* [4] [three.js cannon.jsç‰©ç†å¼•æ“ä¹‹Heightfield](https://www.mrguo.link/article?id=53)
* [5] [Joggin' version 0.1](https://codepen.io/b29/pen/JjyJWEg)
