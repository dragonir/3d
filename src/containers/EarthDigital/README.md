# ä½¿ç”¨Three.jså®ç°ç‚«é…·çš„èµ›åšæœ‹å…‹é£æ ¼3Dæ•°å­—åœ°çƒå¤§å± ğŸŒ

![banner](./images/banner.gif)

> å£°æ˜ï¼šæœ¬æ–‡æ¶‰åŠå›¾æ–‡å’Œæ¨¡å‹ç´ æä»…ç”¨äºä¸ªäººå­¦ä¹ ã€ç ”ç©¶å’Œæ¬£èµï¼Œè¯·å‹¿äºŒæ¬¡ä¿®æ”¹ã€éæ³•ä¼ æ’­ã€è½¬è½½ã€å‡ºç‰ˆã€å•†ç”¨ã€åŠè¿›è¡Œå…¶ä»–è·åˆ©è¡Œä¸ºã€‚

## èƒŒæ™¯

![role](./images/role.png)

è¿‘æœŸå·¥ä½œæœ‰æ¶‰åŠåˆ°æ•°å­—å¤§å±çš„éœ€æ±‚ï¼Œäºæ˜¯åˆ©ç”¨ä¸šä½™æ—¶é—´ï¼Œç»“åˆ `Three.js` å’Œ [CSSå®ç°èµ›åšæœ‹å…‹2077é£æ ¼è§†è§‰æ•ˆæœ](https://juejin.cn/post/6972759988632551460) å®ç°ç‚«é…· `3D` æ•°å­—åœ°çƒå¤§å±é¡µé¢ã€‚é¡µé¢ä½¿ç”¨ `React + Three.js + Echarts + stylus` æŠ€æœ¯æ ˆï¼Œæœ¬æ–‡æ¶‰åŠåˆ°çš„ä¸»è¦çŸ¥è¯†ç‚¹åŒ…æ‹¬ï¼š`THREE.Spherical` çƒä½“åæ ‡ç³»çš„åº”ç”¨ã€`Shader` ç»“åˆ `TWEEN` å®ç°é£çº¿å’Œå†²å‡»æ³¢åŠ¨ç”»æ•ˆæœã€`dat.GUI` è°ƒè¯•å·¥å…·åº“çš„ä½¿ç”¨ã€`clip-path` åˆ›å»ºä¸è§„åˆ™å›¾å½¢ã€`Echarts` çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ã€`radial-gradient` åˆ›å»ºé›·è¾¾å›¾å½¢åŠåŠ¨ç”»ã€`GlitchPass` æ·»åŠ æ•…éšœé£æ ¼åæœŸã€`Raycaster` ç½‘æ ¼ç‚¹å‡»äº‹ä»¶ç­‰ã€‚

## æ•ˆæœ

å¦‚ä¸‹å›¾ `ğŸ‘‡` æ‰€ç¤ºï¼Œé¡µé¢ä¸»è¦å¤´éƒ¨ã€ä¸¤ä¾§å¡ç‰‡ã€åº•éƒ¨ä»ªè¡¨ç›˜ä»¥åŠä¸»ä½“ `3D` åœ°çƒ `ğŸŒ` æ„æˆï¼Œåœ°çƒå¤–å›´æœ‰ `é£çº¿` åŠ¨ç”»å’Œ `å†²å‡»æ³¢` åŠ¨ç”»æ•ˆæœ `ğŸŒ ` ï¼Œé€šè¿‡ `ğŸ–±` é¼ æ ‡å¯ä»¥æ—‹è½¬å’Œæ”¾å¤§åœ°çƒã€‚ç‚¹å‡»ç¬¬ä¸€å¼ å¡ç‰‡çš„ `START` `â¬œ` æŒ‰é’®ä¼šç»™é¡µé¢æ·»åŠ æ•…éšœé£æ ¼åæœŸ `âš¡`ï¼Œ**åŒå‡»**åœ°çƒä¼šå¼¹å‡ºéšæœºæç¤ºè¯­å¼¹çª—ã€‚

![scale](./images/scale.gif)

* `ğŸ’»` æœ¬é¡µé¢ä»…é€‚é… `PC` ç«¯ï¼Œå¤§å±è®¿é—®æ•ˆæœæ›´ä½³ã€‚
* `ğŸ‘â€ğŸ—¨` åœ¨çº¿é¢„è§ˆåœ°å€1ï¼š<https://3d-eosin.vercel.app/#/earthDigital>
* `ğŸ‘â€ğŸ—¨` åœ¨çº¿é¢„è§ˆåœ°å€2ï¼š<https://dragonir.github.io/3d/#/earthDigital>

## å®ç°

### `ğŸ“¦` èµ„æºå¼•å…¥

å¼•å…¥å¼€å‘å¿…å¤‡çš„èµ„æºï¼Œå…¶ä¸­é™¤äº†åŸºç¡€çš„ `React` å’Œæ ·å¼è¡¨ä¹‹å¤–ï¼Œ`dat.gui` ç”¨äºåŠ¨æ€æ§åˆ¶é¡µé¢å‚æ•°ï¼Œå…¶ä»–å‰©ä½™çš„ä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š**Three.js**ç›¸å…³ï¼Œ `OrbitControls` ç”¨äºé•œå¤´è½¨é“æ§åˆ¶ã€`TWEEN` ç”¨äºè¡¥é—´åŠ¨ç”»æ§åˆ¶ã€`mergeBufferGeometries` ç”¨æˆ·åˆå¹¶æ¨¡å‹ã€`EffectComposer` `RenderPass` `GlitchPass` ç”¨äºç”ŸæˆåæœŸæ•…éšœæ•ˆæœåŠ¨ç”»ã€ `lineFragmentShader` æ˜¯é£çº¿çš„ `Shader`ã€**Echarts**ç›¸å…³æŒ‰éœ€å¼•å…¥éœ€è¦çš„ç»„ä»¶ï¼Œæœ€åä½¿ç”¨ `echarts.use` ä½¿å…¶ç”Ÿæ•ˆã€‚

```js
import './index.styl';
import React from 'react';
import * as dat from 'dat.gui';
// three.js ç›¸å…³
import * as THREE from 'three';
import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls';
import { TWEEN } from 'three/examples/jsm/libs/tween.module.min.js';
import { mergeBufferGeometries } from 'three/examples/jsm/utils/BufferGeometryUtils';
import { EffectComposer } from 'three/examples/jsm/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/examples/jsm/postprocessing/RenderPass.js';
import { GlitchPass } from 'three/examples/jsm/postprocessing/GlitchPass.js';
import lineFragmentShader from '@/containers/EarthDigital/shaders/line/fragment.glsl';
// echarts ç›¸å…³
import * as echarts from 'echarts/core';
import { BarChart /*...*/ } from 'echarts/charts';
import { GridComponent /*...*/ } from 'echarts/components';
import { LabelLayout /*...*/ } from 'echarts/features';
import { CanvasRenderer } from 'echarts/renderers';
echarts.use([BarChart, GridComponent, /* ...*/ ]);
```

### `ğŸ“ƒ` é¡µé¢ç»“æ„

é¡µé¢ä¸»è¦ç»“æ„å¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤ºï¼Œ`.webgl` ç”¨äºæ¸²æŸ“ `3D` æ•°å­—åœ°çƒï¼›`.header` æ˜¯é¡µé¢é¡¶éƒ¨ï¼Œé‡Œé¢åŒ…æ‹¬**æ—¶é—´**ã€**æ—¥æœŸ**ã€**æ˜Ÿé™…åæ ‡**ã€`Cyberpunk 2077 Logo`ã€æœ¬äºº `Github` ä»“åº“åœ°å€ç­‰ï¼›`.aside` æ˜¯å·¦å³ä¸¤ä¾§çš„å›¾è¡¨å±•ç¤ºåŒºåŸŸï¼›`.footer` æ˜¯åº•éƒ¨çš„ä»ªè¡¨ç›˜ï¼Œå±•ç¤ºä¸€äº›é›·è¾¾åŠ¨ç”»å’Œæ–‡æœ¬ä¿¡æ¯ï¼›å¦‚æœä»”ç»†è§‚å¯Ÿï¼Œå¯ä»¥çœ‹å‡ºèƒŒæ™¯æœ‰**å™ªç‚¹**æ•ˆæœï¼Œ`.bg` å°±æ˜¯ç”¨äºç”Ÿæˆå™ªç‚¹èƒŒæ™¯æ•ˆæœã€‚

```js
<div className='earth_digital'>
  <canvas className='webgl'></canvas>
  <header className='hud header'>
  <header></header>
  <aside className='hud aside left'></aside>
  <aside className='hud aside right'></aside>
  <footer className='hud footer'></footer>
  <section className="bg"></section>
</div>
```

### `ğŸ”©` åœºæ™¯åˆå§‹åŒ–

å®šä¹‰ä¸€äº›å…¨å±€å˜é‡å’Œå‚æ•°ï¼Œåˆå§‹åŒ–**åœºæ™¯**ã€**ç›¸æœº**ã€**é•œå¤´è½¨é“æ§åˆ¶å™¨**ã€**é¡µé¢ç¼©æ”¾ç›‘å¬**ã€æ·»åŠ é¡µé¢**é‡ç»˜æ›´æ–°åŠ¨ç”»**ç­‰è¿›è¡Œåœºæ™¯åˆå§‹åŒ–ã€‚

```js
const renderer = new THREE.WebGLRenderer({
  canvas: document.querySelector('canvas.webgl'),
  antialias: true,
  alpha: true
});
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
// åˆ›å»ºåœºæ™¯
const scene = new THREE.Scene();
// åˆ›å»ºç›¸æœº
const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, .01, 50);
camera.position.set(0, 0, 15.5);
// æ·»åŠ é•œå¤´è½¨é“æ§åˆ¶å™¨
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.enablePan = false;
// é¡µé¢ç¼©æ”¾ç›‘å¬å¹¶é‡æ–°æ›´æ–°åœºæ™¯å’Œç›¸æœº
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize( window.innerWidth, window.innerHeight );
}, false);
// é¡µé¢é‡ç»˜åŠ¨ç”»
renderer.setAnimationLoop( _ => {
  TWEEN.update();
  earth.rotation.y += 0.001;
  renderer.render(scene, camera);
});
```

### `ğŸŒ` åˆ›å»ºç‚¹çŠ¶åœ°çƒ

å…·ä½“æ€è·¯æ˜¯ä½¿ç”¨ `THREE.Spherical` åˆ›å»ºä¸€ä¸ªçƒä½“åæ ‡ç³» `ã€½`ï¼Œç„¶ååˆ›å»º `10000` ä¸ªå¹³é¢ç½‘æ ¼åœ†ç‚¹ï¼Œå°†å®ƒä»¬çš„ç©ºé—´åæ ‡è½¬æ¢æˆçƒåæ ‡ï¼Œå¹¶ä½¿ç”¨ `mergeBufferGeometries` å°†å®ƒä»¬åˆå¹¶ä¸ºä¸€ä¸ªç½‘æ ¼ã€‚ç„¶åä½¿ç”¨ä¸€å¼ å¦‚ä¸‹å›¾æ‰€ç¤ºçš„åœ°å›¾å›¾ç‰‡ä½œä¸ºæè´¨ï¼Œåœ¨ `shader` ä¸­æ ¹æ®æè´¨å›¾ç‰‡çš„é¢œè‰²åˆ†å¸ƒè°ƒæ•´åœ†ç‚¹çš„å¤§å°å’Œé€æ˜åº¦ï¼Œæ ¹æ®ä¼ å…¥çš„å‚æ•°è°ƒæ•´åœ†ç‚¹çš„é¢œè‰²å’Œå¤§å°æ¯”ä¾‹ã€‚ç„¶ååˆ›å»ºä¸€ä¸ªçƒä½“ `SphereGeometry`ï¼Œä½¿ç”¨ç”Ÿæˆçš„ç€è‰²å™¨æè´¨ï¼Œå¹¶å°†å®ƒæ·»åŠ åˆ°åœºæ™¯ä¸­ã€‚åˆ°æ­¤ï¼Œä¸€ä¸ªç‚¹çŠ¶åœ°çƒ `ğŸŒ` æ¨¡å‹å°±å®Œæˆäº†ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ã€‚

![step_0](./images/earth.jpg)

```js
// åˆ›å»ºçƒç±»åæ ‡
let sph = new THREE.Spherical();
let dummyObj = new THREE.Object3D();
let p = new THREE.Vector3();
let geoms = [], rad = 5, r = 0;
let dlong = Math.PI * (3 - Math.sqrt(5));
let dz = 2 / counter;
let long = 0;
let z = 1 - dz / 2;
let params = {
  colors: { base: '#f9f002', gradInner: '#8ae66e', gradOuter: '#03c03c' },
  reset: () => { controls.reset() }
}
let uniforms = {
  impacts: { value: impacts },
  // é™†åœ°è‰²å—å¤§å°
  maxSize: { value: .04 },
  // æµ·æ´‹è‰²å—å¤§å°
  minSize: { value: .025 },
  // å†²å‡»æ³¢é«˜åº¦
  waveHeight: { value: .1 },
  // å†²å‡»æ³¢èŒƒå›´
  scaling: { value: 1 },
  // å†²å‡»æ³¢å¾„å‘æ¸å˜å†…ä¾§é¢œè‰²
  gradInner: { value: new THREE.Color(params.colors.gradInner) },
  // å†²å‡»æ³¢å¾„å‘æ¸å˜å¤–ä¾§é¢œè‰²
  gradOuter: { value: new THREE.Color(params.colors.gradOuter) }
}
// åˆ›å»º10000ä¸ªå¹³é¢åœ†ç‚¹ç½‘æ ¼å¹¶å°†å…¶å®šä½åˆ°çƒåæ ‡
for (let i = 0; i < 10000; i++) {
  r = Math.sqrt(1 - z * z);
  p.set( Math.cos(long) * r, z, -Math.sin(long) * r).multiplyScalar(rad);
  z = z - dz;
  long = long + dlong;
  sph.setFromVector3(p);
  dummyObj.lookAt(p);
  dummyObj.updateMatrix();
  let g =  new THREE.PlaneGeometry(1, 1);
  g.applyMatrix4(dummyObj.matrix);
  g.translate(p.x, p.y, p.z);
  let centers = [p.x, p.y, p.z, p.x, p.y, p.z, p.x, p.y, p.z, p.x, p.y, p.z];
  let uv = new THREE.Vector2((sph.theta + Math.PI) / (Math.PI * 2), 1. - sph.phi / Math.PI);
  let uvs = [uv.x, uv.y, uv.x, uv.y, uv.x, uv.y, uv.x, uv.y];
  g.setAttribute('center', new THREE.Float32BufferAttribute(centers, 3));
  g.setAttribute('baseUv', new THREE.Float32BufferAttribute(uvs, 2));
  geoms.push(g);
}
// å°†å¤šä¸ªç½‘æ ¼åˆå¹¶ä¸ºä¸€ä¸ªç½‘æ ¼
let g = mergeBufferGeometries(geoms);
let m = new THREE.MeshBasicMaterial({
  color: new THREE.Color(params.colors.base),
  onBeforeCompile: shader => {
    shader.uniforms.impacts = uniforms.impacts;
    shader.uniforms.maxSize = uniforms.maxSize;
    shader.uniforms.minSize = uniforms.minSize;
    shader.uniforms.waveHeight = uniforms.waveHeight;
    shader.uniforms.scaling = uniforms.scaling;
    shader.uniforms.gradInner = uniforms.gradInner;
    shader.uniforms.gradOuter = uniforms.gradOuter;
    // å°†åœ°çƒå›¾ç‰‡ä½œä¸ºå‚æ•°ä¼ é€’ç»™shader
    shader.uniforms.tex = { value: new THREE.TextureLoader().load(imgData) };
    shader.vertexShader = vertexShader;
    shader.fragmentShader = fragmentShader;
    );
  }
});
// åˆ›å»ºçƒä½“
const earth = new THREE.Mesh(g, m);
earth.rotation.y = Math.PI;
earth.add(new THREE.Mesh(new THREE.SphereGeometry(4.9995, 72, 36), new THREE.MeshBasicMaterial({ color: new THREE.Color(0x000000) })));
earth.position.set(0, -.4, 0);
scene.add(earth);
```

![step_0](./images/step_0.png)

### `ğŸ”§` æ·»åŠ è°ƒè¯•å·¥å…·

ä¸ºäº†å®æ—¶è°ƒæ•´çƒä½“çš„æ ·å¼å’Œåç»­é£çº¿å’Œå†²å‡»æ³¢çš„å‚æ•°è°ƒæ•´ï¼Œå¯ä»¥ä½¿ç”¨å·¥å…·åº“ `dat.GUI`ã€‚å®ƒå¯ä»¥åˆ›å»ºä¸€ä¸ªè¡¨å•æ·»åŠ åˆ°é¡µé¢ï¼Œé€šè¿‡è°ƒæ•´è¡¨å•ä¸Šé¢çš„å‚æ•°ã€æ»‘å—å’Œæ•°å€¼ç­‰æ–¹å¼ç»‘å®šé¡µé¢å‚æ•°ï¼Œå‚æ•°å€¼æ›´æ”¹åå¯ä»¥å®æ—¶æ›´æ–°ç”»é¢ï¼Œè¿™æ ·å°±ä¸ç”¨ä¸€è¾¹åˆ°ç¼–è¾‘å™¨è°ƒæ•´ä»£ç ä¸€è¾¹åˆ°æµè§ˆå™¨æŸ¥çœ‹æ•ˆæœäº†ã€‚åŸºæœ¬ç”¨æ³•å¦‚ä¸‹ï¼Œæœ¬ä¾‹ä¸­å¯ä»¥åœ¨é¡µé¢é€šè¿‡ç‚¹å‡»é”®ç›˜ `âŒ¨` **Hé”®**æ˜¾ç¤ºæˆ–éšè—å‚æ•°è¡¨å•ï¼Œé€šè¿‡è¡¨å•å¯ä»¥ä¿®æ”¹ `ğŸŒ` åœ°çƒèƒŒæ™¯è‰²ã€é£çº¿é¢œè‰²ã€å†²å‡»æ³¢å¹…åº¦å¤§å°ç­‰æ•ˆæœã€‚

```js
const gui = new dat.GUI();
gui.add(uniforms.maxSize, 'value', 0.01, 0.06).step(0.001).name('é™†åœ°');
gui.add(uniforms.minSize, 'value', 0.01, 0.06).step(0.001).name('æµ·æ´‹');
gui.addColor(params.colors, 'base').name('åŸºç¡€è‰²').onChange(val => {
 earth && earth.material.color.set(val);
});
```

![step_1](./images/step_1.png)

> `ğŸ“Œ` å¦‚æœæƒ³è¦äº†è§£æ›´å¤šå…³äº `dat.GUI` çš„å±æ€§å’Œæ–¹æ³•ï¼Œå¯ä»¥è®¿é—®æœ¬æ–‡æœ«å°¾æä¾›çš„å®˜æ–¹æ–‡æ¡£åœ°å€

### `ğŸ’«` æ·»åŠ é£çº¿å’Œå†²å‡»æ³¢

è¿™éƒ¨åˆ†å†…å®¹å®ç°åœ°çƒè¡¨å±‚çš„é£çº¿å’Œå†²å‡»æ³¢æ•ˆæœ `ğŸŒ `ï¼ŒåŸºæœ¬æ€è·¯æ˜¯ï¼šä½¿ç”¨ `THREE.Line` åˆ›å»º `10` æ¡éšæœºä½ç½®çš„é£çº¿è·¯å¾„ï¼Œé€šè¿‡ `setPath` æ–¹æ³•è®¾ç½®é£çº¿çš„è·¯å¾„ ç„¶åé€šè¿‡ `TWEEN` æ›´æ–°é£çº¿å’Œå†²å‡»æ³¢æ‰©æ•£åŠ¨ç”»ï¼Œä¸€æ¡åŠ¨ç”»ç»“æŸåï¼Œåœ¨ç»ˆç‚¹çš„ä½ç½®åŸºç¡€ä¸Šé‡æ–°è°ƒæ•´é£çº¿å¼€å§‹çš„ä½ç½®ï¼Œé€šè¿‡æ›´æ–° `Shader` å‚æ•° å®ç°é£çº¿å’Œå†²å‡»æ³¢æ•ˆæœï¼Œå¹¶å¾ªç¯æ‰§è¡Œè¯¥è¿‡ç¨‹ï¼Œæœ€åå°†é£çº¿å’Œå†²å‡»æ³¢å…³è”åˆ°åœ°çƒ `ğŸŒ` ä¸Šï¼Œå…·ä½“å®ç°å¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤ºï¼š

```js
let maxImpactAmount = 10, impacts = [];
let trails = [];
for (let i = 0; i < maxImpactAmount; i++) {
  impacts.push({
    impactPosition: new THREE.Vector3().random().subScalar(0.5).setLength(5),
    impactMaxRadius: 5 * THREE.Math.randFloat(0.5, 0.75),
    impactRatio: 0,
    prevPosition: new THREE.Vector3().random().subScalar(0.5).setLength(5),
    trailRatio: {value: 0},
    trailLength: {value: 0}
  });
  makeTrail(i);
}
// åˆ›å»ºè™šçº¿æè´¨å’Œçº¿ç½‘æ ¼å¹¶è®¾ç½®è·¯å¾„
function makeTrail(idx){
  let pts = new Array(100 * 3).fill(0);
  let g = new THREE.BufferGeometry();
  g.setAttribute('position', new THREE.Float32BufferAttribute(pts, 3));
  let m = new THREE.LineDashedMaterial({
    color: params.colors.gradOuter,
    transparent: true,
    onBeforeCompile: shader => {
      shader.uniforms.actionRatio = impacts[idx].trailRatio;
      shader.uniforms.lineLength = impacts[idx].trailLength;
      // ç‰‡æ®µç€è‰²å™¨
      shader.fragmentShader = lineFragmentShader;
    }
  });
  // åˆ›å»ºé£çº¿
  let l = new THREE.Line(g, m);
  l.userData.idx = idx;
  setPath(l, impacts[idx].prevPosition, impacts[idx].impactPosition, 1);
  trails.push(l);
}
// é£çº¿ç½‘æ ¼ã€èµ·ç‚¹ä½ç½®ã€ç»ˆç‚¹ä½ç½®ã€é¡¶ç‚¹é«˜åº¦
function setPath(l, startPoint, endPoint, peakHeight) {
  let pos = l.geometry.attributes.position;
  let division = pos.count - 1;
  let peak = peakHeight || 1;
  let radius = startPoint.length();
  let angle = startPoint.angleTo(endPoint);
  let arcLength = radius * angle;
  let diameterMinor = arcLength / Math.PI;
  let radiusMinor = (diameterMinor * 0.5) / cycle;
  let peakRatio = peak / diameterMinor;
  let radiusMajor = startPoint.length() + radiusMinor;
  let basisMajor = new THREE.Vector3().copy(startPoint).setLength(radiusMajor);
  let basisMinor = new THREE.Vector3().copy(startPoint).negate().setLength(radiusMinor);
  let tri = new THREE.Triangle(startPoint, endPoint, new THREE.Vector3());
  let nrm = new THREE.Vector3();
  tri.getNormal(nrm);
  let v3Major = new THREE.Vector3();
  let v3Minor = new THREE.Vector3();
  let v3Inter = new THREE.Vector3();
  let vFinal = new THREE.Vector3();
  for (let i = 0; i <= division; i++) {
    let divisionRatio = i / division;
    let angleValue = angle * divisionRatio;
    v3Major.copy(basisMajor).applyAxisAngle(nrm, angleValue);
    v3Minor.copy(basisMinor).applyAxisAngle(nrm, angleValue + Math.PI * 2 * divisionRatio * 1);
    v3Inter.addVectors(v3Major, v3Minor);
    let newLength = ((v3Inter.length() - radius) * peakRatio) + radius;
    vFinal.copy(v3Inter).setLength(newLength);
    pos.setXYZ(i, vFinal.x, vFinal.y, vFinal.z);
  }
  pos.needsUpdate = true;
  l.computeLineDistances();
  l.geometry.attributes.lineDistance.needsUpdate = true;
  impacts[l.userData.idx].trailLength.value = l.geometry.attributes.lineDistance.array[99];
  l.material.dashSize = 3;
}
```

æ·»åŠ åŠ¨ç”»è¿‡æ¸¡æ•ˆæœ

```js
for (let i = 0; i < maxImpactAmount; i++) {
  tweens.push({
    runTween: () => {
      let path = trails[i];
      let speed = 3;
      let len = path.geometry.attributes.lineDistance.array[99];
      let dur = len / speed;
      let tweenTrail = new TWEEN.Tween({ value: 0 })
        .to({value: 1}, dur * 1000)
        .onUpdate( val => {
          impacts[i].trailRatio.value = val.value;
        });
        var tweenImpact = new TWEEN.Tween({ value: 0 })
        .to({ value: 1 }, THREE.Math.randInt(2500, 5000))
        .onUpdate(val => {
          uniforms.impacts.value[i].impactRatio = val.value;
        })
        .onComplete(val => {
          impacts[i].prevPosition.copy(impacts[i].impactPosition);
          impacts[i].impactPosition.random().subScalar(0.5).setLength(5);
          setPath(path, impacts[i].prevPosition, impacts[i].impactPosition, 1);
          uniforms.impacts.value[i].impactMaxRadius = 5 * THREE.Math.randFloat(0.5, 0.75);
          tweens[i].runTween();
        });
      tweenTrail.chain(tweenImpact);
      tweenTrail.start();
    }
  });
}
```

![step_2](./images/step_2.png)

### ğŸ“Ÿ åˆ›å»ºå¤´éƒ¨

å¤´éƒ¨**æœºç”²é£æ ¼**çš„å½¢çŠ¶æ˜¯é€šè¿‡çº¯ `CSS` å®ç°çš„ï¼Œåˆ©ç”¨ `clip-path` å±æ€§ï¼Œä½¿ç”¨ä¸åŒçš„è£å‰ªæ–¹å¼åˆ›å»ºå…ƒç´ çš„å¯æ˜¾ç¤ºåŒºåŸŸï¼ŒåŒºåŸŸå†…çš„éƒ¨åˆ†æ˜¾ç¤ºï¼ŒåŒºåŸŸå¤–çš„éšè—ã€‚

```stylus
.header
  background #f9f002
  clip-path polygon(0 0, 100% 0, 100% calc(100% - 35px), 75% calc(100% - 35px), 72.5% 100%, 27.5% 100%, 25% calc(100% - 35px), 0 calc(100% - 35px), 0 0)
```

> `ğŸ“Œ` å¦‚æœæƒ³äº†è§£å…³äº `clip-path` çš„æ›´å¤šçŸ¥è¯†ï¼Œå¯ä»¥è®¿é—®æ–‡ç« æœ«å°¾æä¾›çš„ `MDN` åœ°å€ã€‚

![step_3](./images/step_3.png)

### ğŸ“Š æ·»åŠ ä¸¤ä¾§å¡ç‰‡

ä¸¤ä¾§çš„ `å¡ç‰‡` `ğŸ´`ï¼Œä¹Ÿæ˜¯æœºç”²é£æ ¼å½¢çŠ¶ï¼ŒåŒæ ·ç”± `clip-path` ç”Ÿæˆçš„ã€‚å¡ç‰‡æœ‰**å®å¿ƒ**ã€**å®å¿ƒç‚¹çŠ¶èƒŒæ™¯**ã€**é•‚ç©ºèƒŒæ™¯**ä¸‰ç§åŸºæœ¬æ ·å¼ã€‚

```stylus
.box
  background-color #000
  clip-path polygon(0px 25px, 26px 0px, calc(60% - 25px) 0px, 60% 25px, 100% 25px, 100% calc(100% - 10px), calc(100% - 15px) calc(100% - 10px), calc(80% - 10px) calc(100% - 10px), calc(80% - 15px) 100%, 80px calc(100% - 0px), 65px calc(100% - 15px), 0% calc(100% - 15px))
  transition all .25s linear
  &.inverse
    border none
    padding 40px 15px 30px
    color #000
    background-color var(--yellow-color)
    border-right 2px solid var(--border-color)
    &::before
      content "T-71"
      background-color #000
      color var(--yellow-color)
  &.dotted, &.dotted::after
    background var(--yellow-color)
    background-image radial-gradient(#00000021 1px, transparent 0)
    background-size 5px 5px
    background-position -13px -3px
```

å¡ç‰‡ä¸Šçš„å›¾è¡¨ `ğŸ“Š`ï¼Œç›´æ¥ä½¿ç”¨çš„æ˜¯ `Eachrts` æ’ä»¶ï¼Œé€šè¿‡ä¿®æ”¹æ¯ä¸ªå›¾è¡¨çš„é…ç½®æ¥é€‚é… `èµ›åšæœ‹å…‹ 2077` çš„æ ·å¼é£æ ¼ã€‚

```js
const chart_1 = echarts.init(document.getElementsByClassName('chart_1')[0], 'dark');
chart_1 && chart_1.setOption(chart_1_option);
```

> `ğŸ“Œ` `Echarts` å›¾æ ‡ä½¿ç”¨ä¸æ˜¯æœ¬æ–‡é‡ç‚¹å†…å®¹ï¼Œæƒ³è¦äº†è§£æ›´å¤šç»†èŠ‚å†…å®¹ï¼Œå¯è®¿é—®å…¶å®˜ç½‘ã€‚

![step_4](./images/step_4.png)

### `â±` æ·»åŠ åº•éƒ¨ä»ªè¡¨ç›˜

åº•éƒ¨ä»ªè¡¨ç›˜ä¸»è¦ç”¨äºæ•°æ®å±•ç¤ºï¼Œå¹¶ä¸”æ·»åŠ äº† `3` ä¸ª**é›·è¾¾**æ‰«æåŠ¨ç”»ï¼Œé›·è¾¾ `ğŸ“¡` å½¢çŠ¶åˆ™æ˜¯é€šè¿‡ `radial-gradient` å¾„å‘æ¸å˜æ¥å®ç°çš„ï¼Œç„¶ååˆ©ç”¨ `::before` å’Œ `::after` ä¼ªå…ƒç´ å®ç°æ‰«æåŠ¨ç”»æ•ˆæœï¼Œå…·ä½“ `keyframes` å®ç°å¯ä»¥æŸ¥çœ‹æ ·å¼æºç ã€‚

```stylus
.radar
  background: radial-gradient(center, rgba(32, 255, 77, 0.3) 0%, rgba(32, 255, 77, 0) 75%), repeating-radial-gradient(rgba(32, 255, 77, 0) 5.8%, rgba(32, 255, 77, 0) 18%, #20ff4d 18.6%, rgba(32, 255, 77, 0) 18.9%), linear-gradient(90deg, rgba(32, 255, 77, 0) 49.5%, #20ff4d 50%, #20ff4d 50%, rgba(32, 255, 77, 0) 50.2%), linear-gradient(0deg, rgba(32, 255, 77, 0) 49.5%, #20ff4d 50%, #20ff4d 50%, rgba(32, 255, 77, 0) 50.2%)
.radar:before
  content ''
  display block
  position absolute
  width 100%
  height 100%
  border-radius: 50%
  animation blips  1.4s 5s infinite linear
.radar:after
  content ''
  display block
  background-image linear-gradient(44deg, rgba(0, 255, 51, 0) 50%, #00ff33 100%)
  width 50%
  height 50%
  animation radar-beam 5s infinite linear
  transform-origin: bottom right
  border-radius 100% 0 0 0
```

![step_5](./images/step_5.png)

### `ğŸ¤³` æ·»åŠ äº¤äº’

#### æ•…éšœé£æ ¼åæœŸ

ç‚¹å‡»ç¬¬ä¸€ä¸ªå¡ç‰‡ä¸Šçš„æŒ‰é’® `START` `â¬œ`ï¼Œæ˜Ÿé™…ä¹‹æ—…è¿›å…¥ `Hard æ¨¡å¼` `ğŸ˜±`ï¼Œé¡µé¢å°†ä¼šäº§ç”Ÿå¦‚ä¸‹å›¾æ‰€ç¤ºçš„**æ•…éšœåŠ¨ç”»**æ•ˆæœã€‚å®ƒæ˜¯é€šè¿‡å¼•å…¥ `Three.js` å†…ç½®çš„åæœŸé€šé“ `GlitchPass` å®ç°çš„ï¼Œæ·»åŠ ä»¥ä¸‹ä»£ç åï¼Œè®°å¾—è¦åœ¨é¡µé¢é‡ç»˜åŠ¨ç”»ä¸­æ›´æ–° `composer`ã€‚

```js
const composer = new EffectComposer(renderer);
composer.addPass( new RenderPass(scene, camera));
const glitchPass = new GlitchPass();
composer.addPass(glitchPass);
```

#### åœ°çƒç‚¹å‡»äº‹ä»¶

ä½¿ç”¨ `Raycaster` ç»™åœ°çƒç½‘æ ¼æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œåœ¨åœ°çƒä¸Š `åŒå‡»é¼ æ ‡` `ğŸ–±`ï¼Œä¼šå¼¹å‡ºä¸€ä¸ªæç¤ºæ¡† `ğŸ’¬`ï¼Œå¹¶ä¼šéšæœºåŠ è½½ä¸€äº›æç¤ºæ–‡æ¡ˆã€‚

```js
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();
window.addEventListener('dblclick', event => {
  mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
  mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);
  const intersects = raycaster.intersectObjects(earth.children);
  if (intersects.length > 0) {
    this.setState({
      showModal: true,
      modelText: tips[Math.floor(Math.random() * tips.length)]
    });
  }
}, false);
```

![step_6](./images/step_6.png)

### `ğŸ¥` æ·»åŠ å…¥åœºåŠ¨ç”»ç­‰å…¶ä»–ç»†èŠ‚

æœ€åï¼Œè¿˜æ·»åŠ äº†ä¸€äº›æ ·å¼ç»†èŠ‚å’ŒåŠ¨ç”»æ•ˆæœï¼Œå¦‚å¤´éƒ¨å’Œä¸¤ä¾§å¡ç‰‡çš„**å…¥åœºåŠ¨ç”»**ã€å¤´éƒ¨æ—¶é—´åæ ‡**æ–‡å­—é—ªçƒåŠ¨ç”»**ã€ç¬¬ä¸€å¼ å¡ç‰‡**æŒ‰é’®æ•…éšœé£æ ¼åŠ¨ç”»**ã€`Cyberpunk 2077 Logo` çš„**é˜´å½±æ•ˆæœ**ç­‰ã€‚ç”±äºæ–‡ç« ç¯‡å¹…æœ‰é™ï¼Œä¸åœ¨è¿™é‡Œç»†è®²ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥è‡ªå·±æŸ¥çœ‹æºç å­¦ä¹ ã€‚ä¹Ÿå¯ä»¥æŸ¥çœ‹é˜…è¯»æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç«  [ä»…ç”¨CSSå‡ æ­¥å®ç°èµ›åšæœ‹å…‹2077é£æ ¼è§†è§‰æ•ˆæœ > ä¼ é€é—¨ `ğŸšª`](https://juejin.cn/post/6972759988632551460) æŸ¥çœ‹æ›´å¤šç»†èŠ‚å†…å®¹ã€‚

## æ€»ç»“

æœ¬æ–‡åŒ…å«çš„æ–°çŸ¥è¯†ç‚¹ä¸»è¦åŒ…æ‹¬ï¼š

* `THREE.Spherical` çƒä½“åæ ‡ç³»çš„åº”ç”¨
* `Shader` ç»“åˆ `TWEEN` å®ç°é£çº¿å’Œå†²å‡»æ³¢åŠ¨ç”»æ•ˆæœ
* `dat.GUI` è°ƒè¯•å·¥å…·åº“çš„ä½¿ç”¨
* `clip-path` åˆ›å»ºä¸è§„åˆ™å›¾å½¢
* `Echarts` çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•
* `radial-gradient` åˆ›å»ºé›·è¾¾å›¾å½¢åŠåŠ¨ç”»
* `GlitchPass` æ·»åŠ æ•…éšœé£æ ¼åæœŸ
* `Raycaster` ç½‘æ ¼ç‚¹å‡»äº‹ä»¶ç­‰

**åç»­è®¡åˆ’**ï¼š

æœ¬é¡µé¢è™½ç„¶å·²ç»åšäº†å¾ˆå¤šæ•ˆæœå’Œä¼˜åŒ–ï¼Œä½†æ˜¯è¿˜æœ‰å¾ˆå¤šæ”¹è¿›çš„ç©ºé—´ï¼Œåç»­æˆ‘è®¡åˆ’æ›´æ–°çš„å†…å®¹åŒ…æ‹¬ï¼š

* `ğŸŒ` åœ°çƒåæ ‡å’Œå®é™…åœ°ç†åæ ‡ç»“åˆï¼Œå¯ä»¥æ ¹æ®ç»çº¬åº¦å®šä½åˆ°å›½å®¶ã€çœä»½ç­‰å…·ä½“ä½ç½®
* `ğŸ’»` ç¼©æ”¾é€‚é…ä¸åŒå±å¹•å°ºå¯¸
* `ğŸ“Š` å›¾è¡¨ä»¥åŠä»ªè¡¨ç›˜å±•ç¤ºä¸€äº›çœŸå®çš„æ•°æ®å¹¶ä¸”å¯ä»¥å®æ—¶æ›´æ–°
* `ğŸŒ ` å¤´éƒ¨å’Œå¡ç‰‡æ·»åŠ ä¸€äº›ç‚«é…·çš„æè¾¹åŠ¨ç”»
* `ğŸŒŸ` æ·»åŠ å®‡å®™æ˜Ÿç©ºç²’å­èƒŒæ™¯ï¼ˆæœ‰æ—¶é—´çš„è¯ï¼Œç°åœ¨çš„å™ªç‚¹èƒŒæ™¯ä¹Ÿä¸é”™ï¼‰
* `ğŸŒ` æ€§èƒ½ä¼˜åŒ–

> æƒ³äº†è§£å…¶ä»–å‰ç«¯çŸ¥è¯†æˆ–å…¶ä»–æœªåœ¨æœ¬æ–‡ä¸­è¯¦ç»†æè¿°çš„ `Web 3D` å¼€å‘æŠ€æœ¯ç›¸å…³çŸ¥è¯†ï¼Œå¯é˜…è¯»æˆ‘å¾€æœŸçš„æ–‡ç« ã€‚**è½¬è½½è¯·æ³¨æ˜åŸæ–‡åœ°å€å’Œä½œè€…**ã€‚å¦‚æœè§‰å¾—æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œä¸è¦å¿˜äº†**ä¸€é”®ä¸‰è¿å“¦ ğŸ‘**ã€‚

## é™„å½•

* [æˆ‘çš„3Dä¸“æ å¯ä»¥ç‚¹å‡»æ­¤é“¾æ¥è®¿é—® ğŸ‘ˆ](https://juejin.cn/column/7049923956257587213)
* [1]. [ğŸ¦Š Three.js å®ç°3Då¼€æ”¾ä¸–ç•Œå°æ¸¸æˆï¼šé˜¿ç‹¸çš„å¤šå…ƒå®‡å®™](https://juejin.cn/post/7081429595689320478)
* [2]. [ğŸ”¥ Three.js ç«ç„°æ•ˆæœå®ç°è‰¾å°”ç™»æ³•ç¯åŠ¨æ€logo](https://juejin.cn/post/7077726955528781832)
* [3]. [ğŸ¼ Three.js å®ç°2022å†¬å¥¥ä¸»é¢˜3Dè¶£å‘³é¡µé¢ï¼Œå«å†°å¢©å¢©](https://juejin.cn/post/7060292943608807460)
* `...`

* [1]. [ğŸ“· å‰ç«¯å®ç°å¾ˆå“‡å¡çš„æµè§ˆå™¨ç«¯æ‰«ç åŠŸèƒ½](https://juejin.cn/post/7018722520345870350)
* [2]. [ğŸŒ å‰ç«¯ç“¦ç‰‡åœ°å›¾åŠ è½½ä¹‹å¡å°”è¾¾ä¼ è¯´æ—·é‡ä¹‹æ¯](https://juejin.cn/post/7007432493569671182)
* [3]. [ğŸ˜± ä»…ç”¨CSSå‡ æ­¥å®ç°èµ›åšæœ‹å…‹2077é£æ ¼è§†è§‰æ•ˆæœ](https://juejin.cn/post/6972759988632551460)
* `...`

## å‚è€ƒ

* [1]. [https://threejs.org](https://threejs.org)
* [2]. [https://github.com/dataarts/dat.gui/blob/master/API.md](https://github.com/dataarts/dat.gui/blob/master/API.md)
* [3]. [https://echarts.apache.org/zh/index.html](https://echarts.apache.org/zh/index.html)
* [4]. [https://www.cnblogs.com/pangys/p/13276936.html](https://www.cnblogs.com/pangys/p/13276936.html)
* [5]. [https://developer.mozilla.org/zh-CN/docs/Web/CSS/gradient/radial-gradient](https://developer.mozilla.org/zh-CN/docs/Web/CSS/gradient/radial-gradient)
* [6]. [https://developer.mozilla.org/zh-CN/docs/Web/CSS/clip-path](https://developer.mozilla.org/zh-CN/docs/Web/CSS/clip-path)
